generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (NEW) ---
// Ini mendefinisikan jenis toko untuk membedakan perlakuan (Scraping vs Manual)
enum MarketplaceType {
  SHOPEE
  TOKOPEDIA
  TIKTOK
  LAZADA
  BLIBLI
  WEBSITE_RESMI
  WHATSAPP_LOKAL  // Untuk toko "Boring but True" (Bojonegoro, dll)
  OFFLINE_STORE   // Untuk toko fisik tanpa link, hanya alamat
}

// --- PRODUCT SECTION (UPDATED) ---

model Product {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  
  // ❌ HAPUS: price, shopeeLink, tokpedLink (Dipindah ke ProductLink)
  // ✅ BARU: Cache harga terendah & tertinggi untuk sorting/display cepat
  minPrice    Decimal? @db.Decimal(15, 2) 
  maxPrice    Decimal? @db.Decimal(15, 2)

  // External Links Relation (1 Product = Many Shops)
  links       ProductLink[]

  // Pros & Cons
  pros        String?  @db.Text 
  cons        String?  @db.Text 
   
  images      String[] @default([])
  isFeatured  Boolean  @default(false)
   
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])

  tags        Tag[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ✅ MODEL BARU: PRODUCT LINK (Jembatan Scraping & Manual)
model ProductLink {
  id              String          @id @default(uuid())
  
  // Relasi ke Produk Utama
  productId       String
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Identitas Toko
  marketplace     MarketplaceType
  storeName       String          // Misal: "Samsung Official" atau "Toko Pak Budi"
  region          String?         // PENTING: Isi "Bojonegoro" untuk filter lokal, atau NULL untuk Nasional
  isVerified      Boolean         @default(false) // Centang ini jika toko sudah Anda kurasi aman

  // URL Management
  originalUrl     String          @db.Text // URL Target untuk Bot Scraping
  affiliateUrl    String?         @db.Text // URL Cuan (Redirect user ke sini)
  
  // Harga & Stok (Dinamis)
  currentPrice    Decimal         @db.Decimal(15, 2)
  isStockReady    Boolean         @default(true)
  
  // Monitoring
  lastCheckedAt   DateTime?       // Kapan terakhir Bot/Anda cek harga
  priceHistory    PriceHistory[]  // Relasi ke log sejarah harga

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// ✅ MODEL BARU: PRICE HISTORY (Log Kebenaran)
model PriceHistory {
  id            Int         @id @default(autoincrement()) // Pakai Int biar hemat storage index
  
  productLinkId String
  productLink   ProductLink @relation(fields: [productLinkId], references: [id], onDelete: Cascade)
  
  price         Decimal     @db.Decimal(15, 2)
  recordedAt    DateTime    @default(now())

  @@index([productLinkId, recordedAt]) // Biar query grafik cepat
}

// --- SISANYA TETAP SAMA (Hanya sedikit penyesuaian) ---

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[] 
}

model Post {
  id        String   @id @default(uuid())
  title     String
  slug      String   @unique
  content   Json     // Support Editor.js
  thumbnail String?
  
  // Blog post mungkin masih butuh link referensi langsung, opsional
  referenceLink String? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteSetting {
  id               Int      @id @default(1)
  siteName         String   @default("Jagopilih") // Update default name
  footerAbout      String   @default("Kurasi harga jujur dan toko lokal terpercaya.") @db.Text
  heroTitle        String   @default("Cek Harga Asli, Bukan Harga Diskon Palsu.")
  heroPromo        String   @default("Data Real-Time")
  heroDescription  String   @default("Bandingkan harga marketplace nasional dengan toko tetangga Anda.") @db.Text
  heroImage        String?
  primaryBtnText   String   @default("Cari Produk")
  primaryBtnLink   String   @default("#products")
  secondaryBtnText String   @default("Tentang Kami")
  secondaryBtnLink String   @default("/about")
  updatedAt        DateTime @updatedAt
}

model NavbarLink {
  id        String   @id @default(uuid())
  label     String   
  url       String   
  order     Int      @default(0)
  createdAt DateTime @default(now())
}

model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   
  createdAt DateTime @default(now())
}

model AdminNote {
  id        String   @id @default(uuid())
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}